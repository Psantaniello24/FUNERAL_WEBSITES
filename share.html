<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Meta tag di default, verranno sovrascritti dal JavaScript -->
    <title>Necrologio - Onoranze Funebri Santaniello</title>
    <meta name="description" content="Visualizza i dettagli del necrologio e invia le tue condoglianze alla famiglia.">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="article">
    <meta property="og:site_name" content="Onoranze Funebri Santaniello">
    <meta property="og:locale" content="it_IT">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:type" content="image/jpeg">
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    
    <!-- Script per popolare i meta tag IMMEDIATAMENTE -->
    <script>
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const obituaryId = urlParams.get('id');
            const currentUrl = window.location.href;
            
            if (obituaryId) {
                // Carica i dati dal localStorage (admin panel)
                let obituary = null;
                
                try {
                    const adminData = JSON.parse(localStorage.getItem('obituaries') || '[]');
                    obituary = adminData.find(obit => 
                        `admin_${obit.id}` === obituaryId || 
                        obit.id === obituaryId ||
                        obit.id === obituaryId.replace('admin_', '') ||
                        String(obit.id) === obituaryId.replace('admin_', '')
                    );
                } catch (error) {
                    console.warn('⚠️ Errore caricamento localStorage:', error);
                }
                
                // Se non trovato nel localStorage, prova con Supabase
                if (!obituary) {
                    try {
                        // Carica il file di configurazione Supabase
                        const script = document.createElement('script');
                        script.src = 'js/supabase-config.js';
                        script.onload = function() {
                            if (window.SupabaseManager) {
                                window.SupabaseManager.loadObituaries().then(supabaseData => {
                                    const supabaseObituary = supabaseData.find(obit => 
                                        `supabase_${obit.id}` === obituaryId || 
                                        obit.id === obituaryId ||
                                        String(obit.id) === obituaryId.replace('supabase_', '')
                                    );
                                    
                                    if (supabaseObituary) {
                                        processObituary(supabaseObituary);
                                    } else {
                                        redirectToHome();
                                    }
                                }).catch(error => {
                                    console.warn('⚠️ Errore caricamento Supabase:', error);
                                    redirectToHome();
                                });
                            } else {
                                redirectToHome();
                            }
                        };
                        script.onerror = function() {
                            redirectToHome();
                        };
                        document.head.appendChild(script);
                        return; // Esce dalla funzione per aspettare il caricamento asincrono
                    } catch (error) {
                        console.warn('⚠️ Errore caricamento Supabase:', error);
                    }
                }
                
                if (obituary) {
                    processObituary(obituary);
                } else {
                    redirectToHome();
                }
            } else {
                redirectToHome();
            }
            
            function processObituary(obituary) {
                // Costruisci i dati per la condivisione
                const name = obituary.name || obituary.nome || '';
                const shareTitle = `Ci ha lasciati ${name}`;
                let shareDescription = `Ci ha lasciati ${name}`;
                
                // Gestisci i dati del funerale (diversi formati possibili)
                const funeralDate = obituary.funeralDate || obituary.dataEsequie || '';
                const funeralLocation = obituary.funeralLocation || obituary.luogoEsequie || '';
                const funeralTime = obituary.funeralTime || obituary.oraEsequie || '';
                
                if (funeralDate && funeralLocation) {
                    try {
                        const dateObj = new Date(funeralDate);
                        const formattedDate = dateObj.toLocaleDateString('it-IT', {
                            day: 'numeric',
                            month: 'long', 
                            year: 'numeric'
                        });
                        shareDescription += `, i funerali si svolgeranno ${formattedDate}${funeralTime ? ' alle ' + funeralTime : ''} presso ${funeralLocation}`;
                    } catch (dateError) {
                        shareDescription += `, i funerali si svolgeranno presso ${funeralLocation}`;
                    }
                }
                shareDescription += '. Invia le tue condoglianze alla famiglia.';
                
                // Gestisci l'immagine (diversi formati possibili)
                let shareImage = window.location.origin + '/images/placeholder-person.svg';
                if (obituary.photoFile && obituary.photoFile.data && obituary.photoFile.data.startsWith('http')) {
                    shareImage = obituary.photoFile.data;
                } else if (obituary.photo && obituary.photo.startsWith('http')) {
                    shareImage = obituary.photo;
                } else if (obituary.foto && obituary.foto.startsWith('http')) {
                    shareImage = obituary.foto;
                }
                
                // Scrivi i meta tag usando document.write
                document.write('<title>' + shareTitle.replace(/</g, '&lt;').replace(/>/g, '&gt;') + ' | Onoranze Funebri Santaniello</title>');
                document.write('<meta name="description" content="' + shareDescription.replace(/"/g, '&quot;') + '">');
                
                document.write('<meta property="og:url" content="' + currentUrl + '">');
                document.write('<meta property="og:title" content="' + shareTitle.replace(/"/g, '&quot;') + '">');
                document.write('<meta property="og:description" content="' + shareDescription.replace(/"/g, '&quot;') + '">');
                document.write('<meta property="og:image" content="' + shareImage + '">');
                document.write('<meta property="og:updated_time" content="' + new Date().toISOString() + '">');
                
                document.write('<meta property="twitter:url" content="' + currentUrl + '">');
                document.write('<meta property="twitter:title" content="' + shareTitle.replace(/"/g, '&quot;') + '">');
                document.write('<meta property="twitter:description" content="' + shareDescription.replace(/"/g, '&quot;') + '">');
                document.write('<meta property="twitter:image" content="' + shareImage + '">');
                
                console.log('✅ Meta tag popolati per:', name);
                
                // Reindirizza automaticamente alla pagina di dettaglio dopo 2 secondi
                setTimeout(function() {
                    window.location.href = 'necrologio-detail.html?id=' + obituaryId;
                }, 2000);
            }
            
            function redirectToHome() {
                console.warn('⚠️ Necrologio non trovato o errore caricamento');
                setTimeout(function() {
                    window.location.href = 'index.html';
                }, 2000);
            }
        })();
    </script>
    
    <!-- Tailwind CSS per lo styling -->
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen flex items-center justify-center">
    <div class="max-w-md mx-auto text-center p-8">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
        <h1 class="text-xl font-semibold text-gray-800 mb-2">Caricamento necrologio...</h1>
        <p class="text-gray-600">Verrai reindirizzato tra pochi istanti.</p>
        <div class="mt-6">
            <a href="index.html" class="text-blue-600 hover:text-blue-800 underline">
                Torna alla homepage
            </a>
        </div>
    </div>
</body>
</html>
